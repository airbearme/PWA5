name: AirBear Scheduled Autofix PR
on:
  schedule: [{ cron: "17 8 * * *" }]
  workflow_dispatch:
permissions:
  contents: write
  pull-requests: write
jobs:
  autofix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: pnpm/action-setup@v3
        with: { version: 9 }
      - uses: actions/setup-node@v4
        with: { node-version: 22, cache: "pnpm" }
      - run: pnpm install
      - run: npx -y @biomejs/biome check --write .
      - run: npx -y eslint . --fix || true
      - run: pnpm run type-check || true
      - run: pnpm run build || true
      - name: Open PR if changes
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require("child_process");
            const status = execSync("git status --porcelain=v1").toString().trim();
            if (!status) { core.info("No changes."); return; }
            const branch = `bot/autofix-${new Date().toISOString().slice(0,10)}`;
            execSync(`git checkout -b ${branch}`);
            execSync("git add -A");
            execSync(`git commit -m "chore: scheduled autofix"`);
            execSync(`git push origin ${branch}`);
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "chore: scheduled autofix",
              head: branch,
              base: "main",
              body: "Automated formatting/lint/type fixes (PR-based)."
            });
